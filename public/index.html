<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width" />

  <title>Node-CNTK MNIST Example</title>

  <script type="text/javascript" src="./lib/jquery.1.10.2.min.js"></script>
  <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
  <div class="container" style=" width: '100%'">
    <h1 style="text-align-last: center">Node-CNTK MNIST server</h1>
    <p id="descriptionParagraph">This is a sample application of executing a CNTK trained model using a node server, without the need of installing CNTK
      locally... UPDATE/CHANGE here later</p>
  </div>
  <!-- jQuery UI -->
  <script type="text/javascript" src="./lib/jquery.ui.core.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.widget.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.mouse.1.10.3.min.js"></script>
  <script type="text/javascript" src="./lib/jquery.ui.draggable.1.10.3.min.js"></script>

  <!-- wPaint -->
  <script type="text/javascript" src="./src/wPaint.utils.js"></script>
  <script type="text/javascript" src="./src/wPaint.js"></script>

  <!-- wPaint main -->
  <script type="text/javascript" src="./plugins/main/src/wPaint.menu.main.js"></script>

  <!-- wPaint file -->
  <div id="wrapperDiv">
    <div id="wPaint"></div>
    <div id="result"></div>
  </div>
  </center>
  <img id="img" src="" />
  <div id="buttons">

    <div type="button" title="Go!" onclick="analyzeImage();" style="position: relative;display: inline ; cursor: pointer ">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
        <title>play3</title>
        <path d="M6 4l20 12-20 12z"></path>
      </svg>
    </div>
    <div type="button" title="Clear" onclick="clearAll();" style="position: relative;display: inline ; cursor: pointer ">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 28">
        <title>eraser</title>
        <path d="M14 22l5.25-6h-12l-5.25 6h12zM29.828 5.172c0.313 0.719 0.187 1.547-0.328 2.141l-14 16c-0.375 0.438-0.922 0.688-1.5 0.688h-12c-0.781 0-1.5-0.453-1.828-1.172-0.313-0.719-0.187-1.547 0.328-2.141l14-16c0.375-0.438 0.922-0.688 1.5-0.688h12c0.781 0 1.5 0.453 1.828 1.172z"></path>
      </svg>
    </div>
  </div>

  <center id="wPaint-img"></center>

  <script type="text/javascript">
    function convertBase64ToPixelsArray(base64DataUrl) {
      var mCanvas = (document.createElement('canvas'));

      var ctx = mCanvas.getContext("2d");
      var pixelsArray = [];
      var img = document.getElementById('img');
      var im = new Image();
      im.src = base64DataUrl
      im.onload =
        function getRGB() {
          var scaleWidthRatio = 28 / this.width;
          var scaleHeightRatio = 28 / this.height;

          ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, 28, 28);
          var data = ctx.getImageData(0, 0, 28, 28).data


          for (var i = 0; i < data.length; i += 4) {
            //var grey = (data[i]+data[i+1]+data[i+2])/3;
            color = data[i + 3] > 0 ? 255 : 0;
            pixelsArray.push(color);
          }

          $.ajax({
            url: '/recognize/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ payload: pixelsArray }),
            success: function (resp) {
              var r = document.getElementById('result');
              r.innerText = JSON.parse(resp).digit
            }
          });
        }
    }

    function clearAll() {
      $("#wPaint").wPaint("clear");
      var resultElement = document.getElementById('result');
      resultElement.innerText = ""
    }

    function analyzeImage() {
      var imageData = $("#wPaint").wPaint("image");

      convertBase64ToPixelsArray(imageData);
    }
  </script>

  <script type="text/javascript">
    // init wPaint
    $('#wPaint').wPaint({
    });
  </script>
</body>

</html>